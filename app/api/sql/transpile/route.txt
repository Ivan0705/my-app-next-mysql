import { NextRequest, NextResponse } from "next/server";
import { spawn } from "child_process";
import path from "path";

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();

    console.log("Transpiling SQL...", {
      from: body.from_dialect,
      to: body.to_dialect,
      sql_length: body.sql?.length,
    });

    const pythonProcess = spawn("python", [
      path.join(process.cwd(), "scripts", "sqlglot", "server.py"),
    ]);

    let result = "";
    let error = "";

    pythonProcess.stdin.write(
      JSON.stringify({
        action: "transpile",
        sql: body.sql,
        from_dialect: body.from_dialect || "mysql",
        to_dialect: body.to_dialect || "postgres",
      })
    );
    pythonProcess.stdin.end();

    pythonProcess.stdout.on("data", (data) => {
      result += data.toString();
    });

    pythonProcess.stderr.on("data", (data) => {
      error += data.toString();
      console.error("Python stderr:", data.toString());
    });

    const exitCode = await new Promise<number>((resolve) => {
      pythonProcess.on("close", resolve);
    });

    console.log("Python process exited with code:", exitCode);

    if (exitCode !== 0) {
      return NextResponse.json(
        {
          success: false,
          error: `Python process failed: ${error || "Unknown error"}`,
        },
        { status: 500 }
      );
    }

    try {
      const parsedResult = JSON.parse(result);
      console.log("Transpilation successful");
      return NextResponse.json(parsedResult);
    } catch (parseError) {
      return NextResponse.json(
        {
          success: false,
          error: "Invalid JSON from Python script",
          raw_output: result,
        },
        { status: 500 }
      );
    }
  } catch (error) {
    console.error("API route error:", error);
    return NextResponse.json(
      {
        success: false,
        error: "Internal server error",
      },
      { status: 500 }
    );
  }
}
