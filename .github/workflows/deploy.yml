name: Deploy to GitHub Pages

on:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Handle API routes for static export
        run: |
          if [ -d "app/api" ]; then
            echo "ğŸ“ Temporarily disabling API routes..."
            mv app/api app/_api_temp
          fi
      
      - name: Configure for GitHub Pages
        run: |
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞ½ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
          cp next.config.prod.ts next.config.ts
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ production mode
          echo "NODE_ENV=production" >> $GITHUB_ENV
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ .nojekyll
          touch .nojekyll
          
          echo "âœ… GitHub Pages configuration ready"
      
      - name: Build Next.js
        env:
          NODE_ENV: production
        run: npm run build
      
      - name: Fix CSS paths in HTML files
        run: |
          echo "ğŸ”§ Fixing CSS paths in HTML files..."
          # Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ°Ğ±ÑĞ¾Ğ»ÑÑ‚Ğ½Ñ‹Ğµ Ğ¿ÑƒÑ‚Ğ¸ Ğ½Ğ° Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ² HTML
          if [ -d "out" ]; then
            find out -name "*.html" -type f -exec sed -i 's|href="/_next/|href="./_next/|g' {} \;
            find out -name "*.html" -type f -exec sed -i 's|src="/_next/|src="./_next/|g' {} \;
            echo "âœ… HTML paths fixed"
          else
            echo "âš ï¸ No out/ directory found"
          fi
      
      - name: Fix asset paths in CSS files
        run: |
          echo "ğŸ”§ Fixing asset paths in CSS files..."
          # Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ url() Ğ² CSS Ñ„Ğ°Ğ¹Ğ»Ğ°Ñ…
          if [ -d "out" ]; then
            # ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ğ·Ğ°Ğ¼ĞµĞ½Ğ° - Ğ±Ğ¾Ğ»ĞµĞµ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ°Ñ
            find out -name "*.css" -type f -exec sed -i 's|url(/|url(./|g' {} \;
            echo "âœ… CSS paths fixed"
          else
            echo "âš ï¸ No out/ directory found"
          fi
      
      - name: Verify fixed paths
        run: |
          echo "ğŸ” Verifying fixed paths..."
          
          if [ -f "out/index.html" ]; then
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ HTML
            if grep -q 'href="./_next/' out/index.html; then
              echo "âœ… HTML has relative paths"
            else
              echo "âŒ HTML still has absolute paths"
              echo "First CSS link found:"
              grep -o 'href="[^"]*\.css"' out/index.html | head -1
            fi
          fi
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ CSS Ñ„Ğ°Ğ¹Ğ»Ñ‹
          if [ -d "out/_next/static/css" ]; then
            CSS_COUNT=$(find out/_next/static/css -name "*.css" | wc -l)
            echo "âœ… Found $CSS_COUNT CSS files"
          fi
      
      - name: Create .nojekyll file
        run: |
          # Ğ’Ğ°Ğ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Next.js Ğ½Ğ° GitHub Pages
          touch out/.nojekyll 2>/dev/null || echo "Could not create .nojekyll"
          echo "ğŸ“„ .nojekyll file check complete"
      
      - name: Restore API routes
        if: always()
        run: |
          if [ -d "app/_api_temp" ]; then
            mv app/_api_temp app/api
          fi
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./out

  deploy:
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Show deployment info
        run: |
          echo "ğŸš€ Deployment successful!"
          echo "ğŸŒ Your site: https://ivan0705.github.io/my-app-next-mysql"
          echo "â° It may take 1-2 minutes to propagate"
