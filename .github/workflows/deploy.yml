name: Deploy to GitHub Pages

on:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Remove API routes completely for static build
        run: |
          echo "ğŸ—‘ï¸ Removing API routes for static export..."
          if [ -d "app/api" ]; then
            rm -rf app/api
            echo "âœ… API routes removed"
          else
            echo "â„¹ï¸ No API routes found"
          fi
      
      - name: Configure for GitHub Pages
        run: |
          echo "ğŸ”„ Configuring for static export..."
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞ½ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
          cp next.config.prod.ts next.config.ts
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ production mode
          echo "NODE_ENV=production" >> $GITHUB_ENV
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹
          echo "ğŸ“‹ Config check:"
          grep "output:" next.config.ts || echo "âŒ No output found in config"
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ .nojekyll
          touch .nojekyll
          
          echo "âœ… GitHub Pages configuration ready"
      
      - name: Build Next.js with static export
        env:
          NODE_ENV: production
        run: |
          echo "ğŸ—ï¸ Building with static export..."
          npm run build 2>&1 | tail -100
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ÑĞ±Ğ¾Ñ€ĞºĞ° Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ°
          if [ -d "out" ]; then
            echo "âœ… Build successful - out/ directory created"
            ls -la out/
          else
            echo "âŒ Build failed - no out/ directory"
            echo "Trying alternative build approach..."
            # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ñ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ¾Ğ¼ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
            npx next build 2>&1 || echo "Build attempted"
            if [ -d "out" ]; then
              echo "âœ… Alternative build worked"
            else
              echo "âŒ All build attempts failed"
              exit 1
            fi
          fi
      
      - name: Check build output
        run: |
          echo "ğŸ” Checking build output..."
          if [ -d "out" ]; then
            echo "âœ… out/ directory exists"
            echo "Contents:"
            ls -la out/
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ HTML
            if [ -f "out/index.html" ]; then
              echo "âœ… index.html exists"
              echo "Size: $(wc -l < out/index.html) lines"
            else
              echo "âš ï¸ No index.html found"
              find out -name "*.html" | head -5
            fi
          else
            echo "âŒ ERROR: No out/ directory - build failed!"
            echo "Creating empty out/ for workflow to continue..."
            mkdir -p out
            echo "<html><body>Build failed</body></html>" > out/index.html
          fi
      
      - name: Fix CSS paths in HTML files
        run: |
          echo "ğŸ”§ Fixing CSS paths in HTML files..."
          if [ -d "out" ] && [ -f "out/index.html" ]; then
            find out -name "*.html" -type f -exec sed -i \
              's|href="/_next/|href="./_next/|g; \
               s|src="/_next/|src="./_next/|g' {} \;
            echo "âœ… HTML paths fixed"
          else
            echo "âš ï¸ No HTML files to fix"
          fi
      
      - name: Create .nojekyll file
        run: |
          echo "ğŸ“„ Creating .nojekyll file..."
          touch out/.nojekyll
          echo "âœ… .nojekyll created"
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./out
          retention-days: 1

  deploy:
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Show deployment info
        run: |
          echo "ğŸš€ Deployment successful!"
          echo "ğŸŒ Your site: https://ivan0705.github.io/my-app-next-mysql"
          echo "â° It may take 1-2 minutes to propagate"
